# 美股智能分析选股系统 - 开发任务清单

## 数据库迁移
- [x] 迁移用户表 schema
- [x] 迁移股票数据相关表
- [x] 迁移选股条件和策略表
- [x] 执行数据库迁移 SQL

## 后端业务逻辑迁移
- [x] 迁移 tRPC 路由定义
- [x] 迁移股票数据获取逻辑
- [x] 迁移技术指标计算函数
- [x] 迁移选股筛选逻辑
- [x] 迁移 WebSocket 实时数据推送

## 前端组件迁移
- [ ] 迁移登录页面
- [ ] 迁移仪表盘布局
- [ ] 迁移股票列表组件
- [ ] 迁移股票图表组件（lightweight-charts）
- [ ] 迁移技术指标展示组件
- [ ] 迁移选股条件设置表单

## API 集成
- [ ] 配置 Yahoo Finance API 或 Manus Data API
- [ ] 测试股票数据获取接口
- [ ] 配置实时数据更新机制

## 认证和权限
- [ ] 配置 Manus OAuth 认证流程
- [ ] 实现用户角色权限控制
- [ ] 测试登录登出功能

## 生产环境配置
- [ ] 配置数据库连接
- [ ] 配置环境变量
- [ ] 配置 S3 存储（如需要）
- [ ] 优化构建配置

## 测试和发布
- [ ] 功能测试
- [ ] 性能测试
- [ ] 创建生产检查点
- [ ] 发布永久网站

## 完整页面迁移（用户要求）
- [x] 修复所有前端组件的依赖问题
- [x] 完整迁移 Home 页面（市场概览、自选股、推荐股票）
- [x] 完整迁移 StockDetail 页面（K线图、技术指标、信号分析）
- [x] 完整迁移 Screener 页面（选股筛选器）
- [x] 完整迁移 Backtest 页面（回测会话列表）
- [x] 完整迁移 BacktestSimulator 页面（回测模拟器）
- [x] 实现简易用户认证（用户名/密码登录注册改密）
- [x] 测试所有页面功能

## 图表和指标修复（用户报告问题）
- [x] 详细检查原项目的 StockChart 组件实现
- [x] 检查原项目的技术指标计算（indicators.ts）
- [x] 对比并修复 lightweight-charts 的使用方式
- [x] 确保 K线图正确显示
- [x] 确保技术指标（MACD、蓝黄梯子、买卖力道、动能）正确计算和显示
- [x] 确保买卖压力指标正确显示
- [x] 测试图表交互功能
- [x] 验证所有指标数值准确性

## 回测系统增强（用户新需求）
- [x] K线图买卖点标注：买入时添加持仓成本线（橙色醒目虚线）
- [x] K线图买卖点标注：卖出时添加卖出标记
- [x] 确保买卖标记与CD指标分开显示，不重叠
- [x] 添加回测绩效统计面板：总收益率
- [x] 添加回测绩效统计面板：胜率
- [x] 添加回测绩效统计面板：最大回撤
- [x] 添加回测绩效统计面板：盈亏比
- [x] 创建交易历史记录页面：展示每笔交易详情
- [x] 交易历史记录：时间、价格、数量、盈亏
- [x] 测试所有回测增强功能

## 登录问题修复（用户报告）
- [x] 调查注册后无法登录的原因
- [x] 检查注册流程的 session/cookie 设置
- [x] 检查登录流程的认证逻辑
- [x] 修复注册后自动登录功能
- [x] 测试注册和登录流程

## 登录刷新问题（用户再次报告）
- [x] 检查浏览器控制台错误
- [x] 检查网络请求和响应
- [x] 分析页面刷新后的认证流程
- [x] 修复登录后刷新导致的问题
- [ ] 测试完整的登录流程

## 移除 Manus OAuth 认证系统（用户要求）
- [x] 修改 context.ts 移除 Manus OAuth 认证逻辑
- [x] 简化认证系统只使用本地 JWT token
- [ ] 测试登录和注册功能
- [ ] 验证所有页面的认证保护

## 改用 localStorage 存储 JWT token（用户同意）
- [x] 修改 localAuthRouter 返回 token 而不是设置 cookie
- [x] 修改前端 Login.tsx 将 token 存储到 localStorage
- [x] 修改 tRPC client 配置，在每个请求 header 中发送 token
- [x] 修改 context.ts 从 header 中读取 token
- [x] 修复 Login.tsx 导航逻辑（使用 refetch + setTimeout）
- [x] 测试登录和认证流程（注册、登录、页面跳转、所有功能页面访问）

## 回测系统修复（用户报告无法创建存档和进入）
- [x] 检查回测系统的创建存档功能
- [x] 检查数据库表和路由配置
- [x] 迁移 backtestRouter.ts 并修改为使用 users 表
- [x] 在 index.ts 中注册 /api/backtest 路由
- [x] 修复创建存档的问题
- [x] 测试完整的回测流程（创建存档、进入回测、交易操作、交易记录）
